<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel de Administraci√≥n - Croccon Academia de Rob√≥tica</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="assets/css/styles.css" />
  </head>
  <body>
    <header class="topbar">
      <div class="container nav">
        <a class="brand" href="index.html">Croccon</a>
        <button class="hamburger" id="navToggle" aria-label="Abrir men√∫">‚ò∞</button>
        <nav id="mainNav">
          <a href="admin.html" class="active">Admin</a>
          <a href="tienda.html">Tienda</a>
          <a href="galeria.html">Galer√≠a</a>
          <a href="contacto.html">Contacto</a>
          <button class="btn btn-sm" onclick="logout()">Cerrar Sesi√≥n</button>
        </nav>
      </div>
    </header>

    <main>
      <section class="page-header">
        <div class="container">
          <h1>Panel de Administraci√≥n</h1>
          <p>Gestiona estudiantes, contenidos y reportes</p>
        </div>
      </section>

      <section class="admin-content">
        <div class="container">
          <!-- Pesta√±as de administraci√≥n -->
        <div class="admin-tabs">
          <button class="tab-btn active" data-tab="students">Estudiantes</button>
          <button class="tab-btn" data-tab="kits">Kits</button>
          <button class="tab-btn" data-tab="reports">Reportes</button>
          <button class="tab-btn" data-tab="messages">Mensajes</button>
          <button class="tab-btn" data-tab="redemptions">Canjes</button>
          <button class="tab-btn" data-tab="rewards">Premios</button>
        </div>

          <!-- Tab: Estudiantes -->
          <div class="tab-content active" id="students">
            <h2>Gesti√≥n de Estudiantes</h2>
            <div class="admin-actions">
              <button class="btn" onclick="showAddStudentForm()">Agregar Estudiante</button>
              <button class="btn btn-outline" onclick="exportStudents()">Exportar Lista</button>
            </div>
            
            <div class="students-table">
              <table>
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>Email</th>
                    <th>Millas</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="studentsTableBody">
                  <!-- Los estudiantes se cargar√°n din√°micamente -->
                </tbody>
              </table>
            </div>
          </div>

          <!-- Tab: Kits -->
          <div class="tab-content" id="kits">
            <h2>Gesti√≥n de Kits</h2>
            <div class="admin-actions">
              <button class="btn" onclick="showAddKitForm()">Agregar Kit</button>
              <button class="btn btn-outline" onclick="exportKits()">Exportar Lista</button>
            </div>
            
            <div class="kits-table">
              <table>
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>Categor√≠a</th>
                    <th>Precio</th>
                    <th>Contrase√±a</th>
                    <th>Accesos</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="kitsTableBody">
                  <!-- Los kits se cargar√°n din√°micamente -->
                </tbody>
              </table>
            </div>
          </div>

          <!-- Tab: Reportes -->
          <div class="tab-content" id="reports">
            <h2>Reportes y Estad√≠sticas</h2>
            <div class="stats-grid">
              <div class="stat-card">
                <h3>Total Estudiantes</h3>
                <div class="stat-number" id="totalStudents">0</div>
              </div>
              <div class="stat-card">
                <h3>Millas Otorgadas</h3>
                <div class="stat-number" id="totalMiles">0</div>
              </div>
              <div class="stat-card">
                <h3>Canjes Realizados</h3>
                <div class="stat-number" id="totalRedemptions">0</div>
              </div>
              <div class="stat-card">
                <h3>Mensajes Recibidos</h3>
                <div class="stat-number" id="totalMessages">0</div>
              </div>
            </div>
          </div>

          <!-- Tab: Mensajes -->
          <div class="tab-content" id="messages">
            <h2>Mensajes de Contacto</h2>
            <div id="messagesList">
              <!-- Los mensajes se cargar√°n din√°micamente -->
            </div>
          </div>

          <!-- Tab: Canjes -->
          <div class="tab-content" id="redemptions">
            <h2>Canjes de Puntos</h2>
            <div class="redemptions-table">
              <table>
                <thead>
                  <tr>
                    <th>Estudiante</th>
                    <th>Email</th>
                    <th>Premio</th>
                    <th>Costo (Millas)</th>
                    <th>Fecha</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="redemptionsTableBody">
                  <!-- Los canjes se cargar√°n din√°micamente -->
                </tbody>
              </table>
            </div>
          </div>

          <!-- Tab: Premios F√≠sicos -->
          <div class="tab-content" id="rewards">
            <h2>Gesti√≥n de Premios F√≠sicos</h2>
            <div class="admin-actions">
              <button class="btn" onclick="showAddRewardForm()">Agregar Premio</button>
              <button class="btn btn-outline" onclick="exportRewards()">Exportar Lista</button>
            </div>
            
            <div class="rewards-table">
              <table>
                <thead>
                  <tr>
                    <th>Icono</th>
                    <th>Nombre</th>
                    <th>Descripci√≥n</th>
                    <th>Costo (Millas)</th>
                    <th>Stock</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="rewardsTableBody">
                  <!-- Los premios se cargar√°n din√°micamente -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- Modal Editar Estudiante -->
      <div class="modal-backdrop" id="editModal">
        <div class="modal">
          <header>
            <h3>Editar Estudiante</h3>
            <button class="btn btn-sm btn-outline" onclick="closeEditModal()">Cerrar</button>
          </header>
          <div class="modal-body">
            <form id="editStudentForm">
              <input type="hidden" id="editId">
              <div class="form-group">
                <label>Nombre</label>
                <input type="text" id="editName" required>
              </div>
              <div class="form-group">
                <label>Email</label>
                <input type="email" id="editEmail" required>
              </div>
              <div class="form-group">
                <label>Millas</label>
                <input type="number" id="editMiles" min="0" step="1">
              </div>
            </form>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-outline" onclick="closeEditModal()">Cancelar</button>
            <button type="submit" form="editStudentForm" class="btn">Guardar</button>
          </div>
        </div>
      </div>
    </main>

    <footer class="footer">
      <div class="container foot-grid">
        <div>
          <strong>Croccon</strong>
          <p>Buy One. Plant one.</p>
        </div>
        <div class="right">
          <span>S√≠guenos</span>
          <div class="dots"></div>
        </div>
      </div>
    </footer>

    <script src="assets/js/data.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/app.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Verificar autenticaci√≥n de admin
        const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
        if (!currentUser || currentUser.role !== 'admin') {
          window.location.href = 'login.html';
          return;
        }
        
        // Inicializar pesta√±as
        initTabs();
        
        // Cargar datos iniciales
        loadStudents();
        loadKits();
        loadReports();
        loadMessages();
        loadRedemptions();
        loadRewards();
      });
      
      function initTabs() {
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        
        tabBtns.forEach(btn => {
          btn.addEventListener('click', () => {
            const tabId = btn.dataset.tab;
            
            tabBtns.forEach(b => b.classList.remove('active'));
            tabContents.forEach(c => c.classList.remove('active'));
            
            btn.classList.add('active');
            document.getElementById(tabId).classList.add('active');
          });
        });
      }
      
      function loadStudents() {
        const users = JSON.parse(localStorage.getItem('users') || '[]');
        const students = users.filter(u => u.role === 'estudiante');
        
        const tbody = document.getElementById('studentsTableBody');
        tbody.innerHTML = students.map(student => `
          <tr>
            <td>${student.name}</td>
            <td>${student.email}</td>
            <td>${student.miles || 0}</td>
            <td><span class="status active">Activo</span></td>
            <td>
              <button class="btn btn-sm" onclick="editStudent('${student.id}')">Editar</button>
              <button class="btn btn-sm btn-outline" onclick="viewStudent('${student.id}')">Ver</button>
            </td>
          </tr>
        `).join('');
      }

      function loadKits() {
        const kits = window.CROC_DATA ? window.CROC_DATA.products : [];
        const kitAccess = JSON.parse(localStorage.getItem('kitAccess') || '[]');
        
        const tbody = document.getElementById('kitsTableBody');
        tbody.innerHTML = kits.map(kit => {
          const accessCount = kitAccess.filter(access => access.kitId === kit.id).length;
          return `
            <tr>
              <td>${kit.name}</td>
              <td><span class="level-badge ${kit.category}">${kit.category.toUpperCase()}</span></td>
              <td>$${kit.price}</td>
              <td><code>${kit.password}</code></td>
              <td>
                <span class="access-count">${accessCount} accesos</span>
                <button class="btn btn-sm btn-outline" onclick="viewKitAccess('${kit.id}', '${kit.name}')" style="margin-left: 8px;">
                  Ver Accesos
                </button>
              </td>
              <td><span class="status active">Disponible</span></td>
              <td>
                <button class="btn btn-sm" onclick="editKit('${kit.id}')">Editar</button>
                <button class="btn btn-sm btn-outline" onclick="deleteKit('${kit.id}')">Eliminar</button>
              </td>
            </tr>
          `;
        }).join('');
      }
      
      
      function loadReports() {
        const users = JSON.parse(localStorage.getItem('users') || '[]');
        const students = users.filter(u => u.role === 'estudiante');
        const totalMiles = students.reduce((sum, s) => sum + (s.miles || 0), 0);
        const redemptions = JSON.parse(localStorage.getItem('redemptions') || '[]');
        const messages = JSON.parse(localStorage.getItem('contactMessages') || '[]');
        
        document.getElementById('totalStudents').textContent = students.length;
        document.getElementById('totalMiles').textContent = totalMiles;
        document.getElementById('totalRedemptions').textContent = redemptions.length;
        document.getElementById('totalMessages').textContent = messages.length;
      }
      
      function loadMessages() {
        const messages = JSON.parse(localStorage.getItem('contactMessages') || '[]');
        const messagesList = document.getElementById('messagesList');
        
        messagesList.innerHTML = messages.map(msg => `
          <div class="message-item">
            <h4>${msg.asunto} - ${msg.nombre}</h4>
            <p><strong>Email:</strong> ${msg.email}</p>
            <p><strong>Fecha:</strong> ${msg.fecha}</p>
            <p>${msg.mensaje}</p>
            <div class="message-actions">
              <button class="btn btn-sm" onclick="replyMessage('${msg.id}')">Responder</button>
              <button class="btn btn-sm btn-outline" onclick="markAsRead('${msg.id}')">Marcar como le√≠do</button>
            </div>
          </div>
        `).join('');
      }
      
      function loadRedemptions() {
        const redemptions = JSON.parse(localStorage.getItem('redemptions') || '[]');
        const tbody = document.getElementById('redemptionsTableBody');
        
        tbody.innerHTML = redemptions.map(redemption => `
          <tr>
            <td>${redemption.studentName || 'Usuario no encontrado'}</td>
            <td>${redemption.studentEmail || 'N/A'}</td>
            <td>${redemption.rewardName}</td>
            <td>${redemption.cost}</td>
            <td>${redemption.date}</td>
            <td><span class="status ${redemption.status}">${redemption.status}</span></td>
            <td>
              ${redemption.status === 'pendiente' ? `
                <button class="btn btn-sm" onclick="approveRedemption('${redemption.id}')">Aprobar</button>
                <button class="btn btn-sm btn-outline" onclick="rejectRedemption('${redemption.id}')">Rechazar</button>
              ` : `
                <span class="text-muted">Procesado</span>
              `}
            </td>
          </tr>
        `).join('');
      }
      
      function showAddStudentForm() {
        document.getElementById('addStudentModal').classList.add('show');
      }

      function showAddKitForm() {
        document.getElementById('addKitModal').classList.add('show');
      }

      function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        modal.classList.remove('show');
        // Quitar el estilo inline para no bloquear futuras aperturas
        if (modal && modal.style) {
          modal.style.removeProperty('display');
        }
      }

      function saveNewStudent() {
        const form = document.getElementById('addStudentForm');
        const formData = new FormData(form);
        
        const name = formData.get('name').trim();
        const email = formData.get('email').trim();
        const password = formData.get('password').trim();
        const miles = parseInt(formData.get('miles')) || 0;
        const status = formData.get('status');
        
        if (!name || !email || !password) {
          alert('Por favor completa todos los campos requeridos');
          return;
        }

        if (password.length < 6) {
          alert('La contrase√±a debe tener al menos 6 caracteres');
          return;
        }

        // Verificar si el email ya existe
        const users = JSON.parse(localStorage.getItem('users') || '[]');
        const existingUser = users.find(u => u.email === email);
        if (existingUser) {
          alert('Ya existe un usuario con este email');
          return;
        }
        
        const newStudent = {
          id: Date.now().toString(),
          name: name,
          email: email,
          username: email,
          password: password,
          role: 'estudiante',
          miles: miles,
          status: status,
          createdBy: 'admin',
          createdAt: new Date().toISOString()
        };

        users.push(newStudent);
        localStorage.setItem('users', JSON.stringify(users));
        
        loadStudents();
        closeModal('addStudentModal');
        form.reset();
        alert(`Estudiante creado correctamente.\nEmail: ${email}\nContrase√±a: ${password}`);
      }

      function saveNewKit() {
        const form = document.getElementById('addKitForm');
        const formData = new FormData(form);
        
        const newKit = {
          id: 'kit-' + Date.now().toString(),
          name: formData.get('name'),
          description: formData.get('description'),
          price: parseFloat(formData.get('price')),
          category: formData.get('category'),
          password: formData.get('password'),
          img: formData.get('img'),
          video: formData.get('video') || 'https://www.youtube.com/embed/dQw4w9WgXcQ'
        };

        // Agregar a los datos existentes
        if (!window.CROC_DATA) {
          window.CROC_DATA = { products: [] };
        }
        window.CROC_DATA.products.push(newKit);
        
        // Guardar en localStorage
        localStorage.setItem('crocconData', JSON.stringify(window.CROC_DATA));
        
        loadKits();
        closeModal('addKitModal');
        form.reset();
        alert('Kit agregado correctamente');
      }

      function editKit(kitId) {
        const kits = window.CROC_DATA ? window.CROC_DATA.products : [];
        const kit = kits.find(k => k.id === kitId);
        if (!kit) return;

        // Llenar el formulario de edici√≥n
        document.getElementById('editKitId').value = kit.id;
        document.getElementById('editKitName').value = kit.name;
        document.getElementById('editKitDescription').value = kit.description || '';
        document.getElementById('editKitPrice').value = kit.price;
        document.getElementById('editKitCategory').value = kit.category;
        document.getElementById('editKitPassword').value = kit.password;
        document.getElementById('editKitImage').value = kit.img;
        document.getElementById('editKitVideo').value = kit.video || '';
        
        // Mostrar el modal
        document.getElementById('editKitModal').classList.add('show');
      }

      function saveKitEdit() {
        const form = document.getElementById('editKitForm');
        const formData = new FormData(form);
        
        const kitId = formData.get('id');
        const name = formData.get('name').trim();
        const description = formData.get('description').trim();
        const price = parseFloat(formData.get('price'));
        const category = formData.get('category');
        const password = formData.get('password').trim();
        const img = formData.get('img').trim();
        const video = formData.get('video').trim();
        
        if (!name || !description || !price || !category || !password || !img) {
          alert('Por favor completa todos los campos requeridos');
          return;
        }
        
        const kits = window.CROC_DATA ? window.CROC_DATA.products : [];
        const kitIndex = kits.findIndex(k => k.id === kitId);
        if (kitIndex !== -1) {
          kits[kitIndex].name = name;
          kits[kitIndex].description = description;
          kits[kitIndex].price = price;
          kits[kitIndex].category = category;
          kits[kitIndex].password = password;
          kits[kitIndex].img = img;
          kits[kitIndex].video = video || 'https://www.youtube.com/embed/dQw4w9WgXcQ';
          
          localStorage.setItem('crocconData', JSON.stringify(window.CROC_DATA));
          loadKits();
          closeModal('editKitModal');
          alert('Kit actualizado correctamente');
        }
      }

      function deleteKit(kitId) {
        if (confirm('¬øEst√°s seguro de que quieres eliminar este kit?')) {
          const kits = window.CROC_DATA ? window.CROC_DATA.products : [];
          const filteredKits = kits.filter(k => k.id !== kitId);
          window.CROC_DATA.products = filteredKits;
          
          localStorage.setItem('crocconData', JSON.stringify(window.CROC_DATA));
          loadKits();
          alert('Kit eliminado correctamente');
        }
      }

      function exportStudents() {
        const users = JSON.parse(localStorage.getItem('users') || '[]');
        const students = users.filter(u => u.role === 'estudiante');
        
        const csv = [
          ['Nombre', 'Email', 'Millas', 'Estado'],
          ...students.map(s => [s.name, s.email, s.miles || 0, 'Activo'])
        ].map(row => row.join(',')).join('\n');
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'estudiantes.csv';
        a.click();
        URL.revokeObjectURL(url);
      }

      function exportKits() {
        const kits = window.CROC_DATA ? window.CROC_DATA.products : [];
        
        const csv = [
          ['Nombre', 'Categor√≠a', 'Precio', 'Contrase√±a', 'Estado'],
          ...kits.map(k => [k.name, k.category, k.price, k.password, 'Disponible'])
        ].map(row => row.join(',')).join('\n');
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'kits.csv';
        a.click();
        URL.revokeObjectURL(url);
      }

      // Funciones para gesti√≥n de premios
      function showAddRewardForm() {
        document.getElementById('addRewardModal').classList.add('show');
      }

      function loadRewards() {
        const rewards = JSON.parse(localStorage.getItem('physicalRewards') || '[]');
        
        const tbody = document.getElementById('rewardsTableBody');
        tbody.innerHTML = rewards.map(reward => `
          <tr>
            <td style="font-size: 24px; text-align: center;">${reward.image}</td>
            <td>${reward.name}</td>
            <td>${reward.description}</td>
            <td>${reward.cost}</td>
            <td>${reward.stock}</td>
            <td><span class="status ${reward.stock > 0 ? 'active' : 'rechazado'}">${reward.stock > 0 ? 'Disponible' : 'Agotado'}</span></td>
            <td>
              <button class="btn btn-sm" onclick="editReward('${reward.id}')">Editar</button>
              <button class="btn btn-sm btn-outline" onclick="deleteReward('${reward.id}')">Eliminar</button>
            </td>
          </tr>
        `).join('');
      }

      function saveNewReward() {
        const form = document.getElementById('addRewardForm');
        const formData = new FormData(form);
        
        const newReward = {
          id: 'reward-' + Date.now().toString(),
          name: formData.get('name').trim(),
          description: formData.get('description').trim(),
          cost: parseInt(formData.get('cost')),
          stock: parseInt(formData.get('stock')),
          image: formData.get('image').trim()
        };

        if (!newReward.name || !newReward.description || !newReward.cost || newReward.stock < 0) {
          alert('Por favor completa todos los campos correctamente');
          return;
        }

        const rewards = JSON.parse(localStorage.getItem('physicalRewards') || '[]');
        rewards.push(newReward);
        localStorage.setItem('physicalRewards', JSON.stringify(rewards));
        
        loadRewards();
        closeModal('addRewardModal');
        form.reset();
        alert('Premio agregado correctamente');
      }

      function editReward(rewardId) {
        console.log('Editando premio:', rewardId);
        const rewards = JSON.parse(localStorage.getItem('physicalRewards') || '[]');
        const reward = rewards.find(r => r.id === rewardId);
        console.log('Premio encontrado:', reward);
        
        if (!reward) {
          alert('Error: No se encontr√≥ el premio a editar');
          return;
        }

        // Llenar el formulario de edici√≥n
        document.getElementById('editRewardId').value = reward.id;
        document.getElementById('editRewardName').value = reward.name;
        document.getElementById('editRewardDescription').value = reward.description;
        document.getElementById('editRewardCost').value = reward.cost;
        document.getElementById('editRewardStock').value = reward.stock;
        document.getElementById('editRewardImage').value = reward.image;
        
        // Mostrar el modal
        const modal = document.getElementById('editRewardModal');
        console.log('Modal encontrado:', modal);
        modal.classList.add('show');
        modal.style.display = 'flex';
        console.log('Modal mostrado');
      }

      function saveRewardEdit() {
        const form = document.getElementById('editRewardForm');
        const formData = new FormData(form);
        
        const rewardId = formData.get('id');
        const name = formData.get('name').trim();
        const description = formData.get('description').trim();
        const cost = parseInt(formData.get('cost'));
        const stock = parseInt(formData.get('stock'));
        const image = formData.get('image').trim();
        
        if (!name || !description || isNaN(cost) || isNaN(stock) || cost <= 0 || stock < 0) {
          alert('Por favor completa todos los campos correctamente');
          return;
        }
        
        const rewards = JSON.parse(localStorage.getItem('physicalRewards') || '[]');
        const rewardIndex = rewards.findIndex(r => r.id === rewardId);
        if (rewardIndex !== -1) {
          rewards[rewardIndex].name = name;
          rewards[rewardIndex].description = description;
          rewards[rewardIndex].cost = cost;
          rewards[rewardIndex].stock = stock;
          rewards[rewardIndex].image = image;
          
          localStorage.setItem('physicalRewards', JSON.stringify(rewards));
          loadRewards();
          closeModal('editRewardModal');
          alert('Premio actualizado correctamente');
        } else {
          alert('Error: No se encontr√≥ el premio a editar');
        }
      }

      function deleteReward(rewardId) {
        if (confirm('¬øEst√°s seguro de que quieres eliminar este premio?')) {
          const rewards = JSON.parse(localStorage.getItem('physicalRewards') || '[]');
          const filteredRewards = rewards.filter(r => r.id !== rewardId);
          
          localStorage.setItem('physicalRewards', JSON.stringify(filteredRewards));
          loadRewards();
          alert('Premio eliminado correctamente');
        }
      }

      function exportRewards() {
        const rewards = JSON.parse(localStorage.getItem('physicalRewards') || '[]');
        
        const csv = [
          ['Nombre', 'Descripci√≥n', 'Costo (Millas)', 'Stock', 'Estado'],
          ...rewards.map(r => [r.name, r.description, r.cost, r.stock, r.stock > 0 ? 'Disponible' : 'Agotado'])
        ].map(row => row.join(',')).join('\n');
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'premios.csv';
        a.click();
        URL.revokeObjectURL(url);
      }

      // Funciones para gesti√≥n de accesos a kits

      function viewKitAccess(kitId, kitName) {
        let kitAccess = JSON.parse(localStorage.getItem('kitAccess') || '[]');
        let kitAccesses = kitAccess.filter(access => access.kitId === kitId);
        
        // Si no hay accesos, agregar datos de ejemplo
        if (kitAccesses.length === 0) {
          const sampleAccesses = generateSampleAccesses(kitId, kitName);
          kitAccess = [...kitAccess, ...sampleAccesses];
          localStorage.setItem('kitAccess', JSON.stringify(kitAccess));
          kitAccesses = sampleAccesses;
        }
        
        // Crear modal mejorado
        const modalHtml = `
          <div class="modal-backdrop show" id="kitAccessModal">
            <div class="modal kit-access-modal">
              <div class="modal-header">
                <div class="modal-title">
                  <div class="kit-icon">ü§ñ</div>
                  <div>
                    <h3>Accesos al Kit</h3>
                    <p class="kit-name">${kitName}</p>
                  </div>
                </div>
                <button class="close-btn" onclick="closeModal('kitAccessModal')">&times;</button>
              </div>
              <div class="modal-body">
                <div class="kit-access-list">
                  <div class="access-summary">
                    <div class="summary-stats">
                      <div class="stat-item">
                        <span class="stat-number">${kitAccesses.length}</span>
                        <span class="stat-label">Total Accesos</span>
                      </div>
                      <div class="stat-item">
                        <span class="stat-number">${new Set(kitAccesses.map(a => a.studentEmail)).size}</span>
                        <span class="stat-label">Usuarios √önicos</span>
                      </div>
                      <div class="stat-item">
                        <span class="stat-number">${getRecentAccesses(kitAccesses)}</span>
                        <span class="stat-label">√öltimos 7 d√≠as</span>
                      </div>
                    </div>
                  </div>
                  
                  <div class="access-filters">
                    <div class="filter-group">
                      <label>Ordenar por:</label>
                      <select id="sortAccess" onchange="sortAccesses()">
                        <option value="recent">M√°s recientes</option>
                        <option value="oldest">M√°s antiguos</option>
                        <option value="student">Por estudiante</option>
                      </select>
                    </div>
                    <div class="filter-group">
                      <label>Buscar:</label>
                      <input type="text" id="searchAccess" placeholder="Nombre o email..." onkeyup="filterAccesses()">
                    </div>
                  </div>
                  
                  <div class="access-items" id="accessItems">
                    ${kitAccesses.map(access => `
                      <div class="access-item" data-student="${access.studentName.toLowerCase()}" data-email="${access.studentEmail.toLowerCase()}">
                        <div class="access-header">
                          <div class="student-info">
                            <div class="student-avatar">${getInitials(access.studentName)}</div>
                            <div class="student-details">
                              <strong>${access.studentName || 'Usuario no identificado'}</strong>
                              <span class="access-email">${access.studentEmail || 'N/A'}</span>
                            </div>
                          </div>
                          <div class="access-time">
                            <span class="time-icon">üïí</span>
                            <span>${access.accessDate}</span>
                          </div>
                        </div>
                        <div class="access-details">
                          <div class="detail-item">
                            <span class="detail-icon">üîë</span>
                            <div class="detail-content">
                              <span class="label">Contrase√±a usada</span>
                              <code>${access.passwordUsed}</code>
                            </div>
                          </div>
                          <div class="detail-item">
                            <span class="detail-icon">üì±</span>
                            <div class="detail-content">
                              <span class="label">Dispositivo</span>
                              <span>${getDeviceType(access.deviceInfo)}</span>
                            </div>
                          </div>
                          <div class="detail-item">
                            <span class="detail-icon">üåê</span>
                            <div class="detail-content">
                              <span class="label">IP/Info</span>
                              <span class="device-info">${access.deviceInfo || 'N/A'}</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    `).join('')}
                  </div>
                </div>
              </div>
              <div class="modal-actions">
                <button class="btn btn-outline" onclick="closeModal('kitAccessModal')">Cerrar</button>
                <button class="btn" onclick="exportKitAccessById('${kitId}', '${kitName}')">
                  üìä Exportar Accesos
                </button>
              </div>
            </div>
          </div>
        `;
        
        // Insertar modal en el DOM
        document.body.insertAdjacentHTML('beforeend', modalHtml);
      }

      // Funciones auxiliares para el modal de accesos
      function generateSampleAccesses(kitId, kitName) {
        const sampleStudents = [
          { name: 'Mar√≠a Gonz√°lez', email: 'maria.gonzalez@email.com' },
          { name: 'Carlos Rodr√≠guez', email: 'carlos.rodriguez@email.com' },
          { name: 'Ana Mart√≠nez', email: 'ana.martinez@email.com' },
          { name: 'Luis Fern√°ndez', email: 'luis.fernandez@email.com' },
          { name: 'Sofia L√≥pez', email: 'sofia.lopez@email.com' }
        ];
        
        const passwords = ['KIT123', 'ARDUINO2024', 'ROBOT001', 'CROCCON2024', 'KIT456'];
        const devices = [
          'Chrome/Windows 10',
          'Safari/macOS',
          'Firefox/Windows 11',
          'Chrome/Android',
          'Edge/Windows 10'
        ];
        
        const now = new Date();
        const sampleAccesses = [];
        
        for (let i = 0; i < 5; i++) {
          const student = sampleStudents[i];
          const daysAgo = Math.floor(Math.random() * 30);
          const accessDate = new Date(now.getTime() - (daysAgo * 24 * 60 * 60 * 1000));
          
          sampleAccesses.push({
            id: Date.now().toString() + i,
            kitId: kitId,
            kitName: kitName,
            passwordUsed: passwords[i],
            studentName: student.name,
            studentEmail: student.email,
            accessDate: accessDate.toLocaleString('es-ES'),
            deviceInfo: devices[i],
            timestamp: accessDate.toISOString()
          });
        }
        
        return sampleAccesses;
      }

      function getInitials(name) {
        return name.split(' ').map(n => n[0]).join('').toUpperCase();
      }

      function getDeviceType(deviceInfo) {
        if (deviceInfo.includes('Chrome')) return 'Chrome';
        if (deviceInfo.includes('Safari')) return 'Safari';
        if (deviceInfo.includes('Firefox')) return 'Firefox';
        if (deviceInfo.includes('Edge')) return 'Edge';
        if (deviceInfo.includes('Android')) return 'Android';
        return 'Otro';
      }

      function getRecentAccesses(accesses) {
        const weekAgo = new Date(Date.now() - (7 * 24 * 60 * 60 * 1000));
        return accesses.filter(access => new Date(access.timestamp) > weekAgo).length;
      }

      function sortAccesses() {
        const sortBy = document.getElementById('sortAccess').value;
        const accessItems = document.getElementById('accessItems');
        const items = Array.from(accessItems.children);
        
        items.sort((a, b) => {
          switch(sortBy) {
            case 'recent':
              return new Date(b.dataset.timestamp) - new Date(a.dataset.timestamp);
            case 'oldest':
              return new Date(a.dataset.timestamp) - new Date(b.dataset.timestamp);
            case 'student':
              return a.dataset.student.localeCompare(b.dataset.student);
            default:
              return 0;
          }
        });
        
        accessItems.innerHTML = '';
        items.forEach(item => accessItems.appendChild(item));
      }

      function filterAccesses() {
        const searchTerm = document.getElementById('searchAccess').value.toLowerCase();
        const accessItems = document.querySelectorAll('.access-item');
        
        accessItems.forEach(item => {
          const student = item.dataset.student;
          const email = item.dataset.email;
          const matches = student.includes(searchTerm) || email.includes(searchTerm);
          item.style.display = matches ? 'block' : 'none';
        });
      }

      function exportKitAccessById(kitId, kitName) {
        const kitAccess = JSON.parse(localStorage.getItem('kitAccess') || '[]');
        const kitAccesses = kitAccess.filter(access => access.kitId === kitId);
        
        const csv = [
          ['Estudiante', 'Email', 'Kit', 'Contrase√±a Usada', 'Fecha de Acceso', 'Dispositivo', 'Estado'],
          ...kitAccesses.map(a => [a.studentName || 'N/A', a.studentEmail || 'N/A', a.kitName, a.passwordUsed, a.accessDate, a.deviceInfo || 'N/A', 'Accedido'])
        ].map(row => row.join(',')).join('\n');
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `accesos_${kitName.replace(/\s+/g, '_')}.csv`;
        a.click();
        URL.revokeObjectURL(url);
      }

      
      function editStudent(studentId) {
        const users = JSON.parse(localStorage.getItem('users') || '[]');
        const student = users.find(u => u.id === studentId);
        if (!student) return;

        // Llenar el formulario de edici√≥n
        document.getElementById('editStudentId').value = student.id;
        document.getElementById('editStudentName').value = student.name;
        document.getElementById('editStudentEmail').value = student.email;
        document.getElementById('editStudentPassword').value = ''; // Dejar vac√≠o para mantener la actual
        document.getElementById('editStudentMiles').value = student.miles || 0;
        document.getElementById('editStudentStatus').value = student.status || 'activo';
        
        // Mostrar el modal
        document.getElementById('editStudentModal').classList.add('show');
      }

      function saveStudentEdit() {
        const form = document.getElementById('editStudentForm');
        const formData = new FormData(form);
        
        const studentId = formData.get('id');
        const name = formData.get('name').trim();
        const email = formData.get('email').trim();
        const password = formData.get('password').trim();
        const miles = parseInt(formData.get('miles')) || 0;
        const status = formData.get('status');
        
        if (!name || !email) {
          alert('Por favor completa todos los campos requeridos');
          return;
        }

        if (password && password.length < 6) {
          alert('La contrase√±a debe tener al menos 6 caracteres');
          return;
        }
        
        const users = JSON.parse(localStorage.getItem('users') || '[]');
        const userIndex = users.findIndex(u => u.id === studentId);
        if (userIndex !== -1) {
          users[userIndex].name = name;
          users[userIndex].email = email;
          users[userIndex].username = email;
          users[userIndex].miles = miles;
          users[userIndex].status = status;
          
          // Solo actualizar contrase√±a si se proporcion√≥ una nueva
          if (password) {
            users[userIndex].password = password;
          }
          
          localStorage.setItem('users', JSON.stringify(users));
          loadStudents();
          closeModal('editStudentModal');
          alert('Estudiante actualizado correctamente');
        }
      }
      
      function viewStudent(studentId) {
        alert(`Viendo estudiante ${studentId}`);
      }
      
      function exportStudents() {
        const users = JSON.parse(localStorage.getItem('users') || '[]');
        const students = users.filter(u => u.role === 'estudiante');
        const csv = 'Nombre,Email,Millas\n' + students.map(s => `${s.name},${s.email},${s.miles || 0}`).join('\n');
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'estudiantes.csv';
        a.click();
      }
      
      function replyMessage(messageId) {
        alert(`Respondiendo mensaje ${messageId}`);
      }
      
      function markAsRead(messageId) {
        alert(`Mensaje ${messageId} marcado como le√≠do`);
      }
      
      function approveRedemption(redemptionId) {
        const redemptions = JSON.parse(localStorage.getItem('redemptions') || '[]');
        const redemption = redemptions.find(r => r.id == redemptionId);
        if (redemption) {
          redemption.status = 'aprobado';
          localStorage.setItem('redemptions', JSON.stringify(redemptions));
          loadRedemptions();
          alert('Canje aprobado');
        }
      }
      
      function rejectRedemption(redemptionId) {
        const redemptions = JSON.parse(localStorage.getItem('redemptions') || '[]');
        const redemption = redemptions.find(r => r.id == redemptionId);
        if (redemption) {
          redemption.status = 'rechazado';
          localStorage.setItem('redemptions', JSON.stringify(redemptions));
          loadRedemptions();
          alert('Canje rechazado');
        }
      }
      
      function logout() {
        localStorage.removeItem('currentUser');
        window.location.href = 'login.html';
      }
      

      // Manejar submit del modal de edici√≥n
      const editFormEl = document.getElementById('editStudentForm');
      if (editFormEl) {
        editFormEl.addEventListener('submit', function(e){
          e.preventDefault();
          saveStudentEdits();
        });
      }

    </script>

    <!-- Modal para agregar estudiante -->
    <div class="modal-backdrop" id="addStudentModal">
      <div class="modal">
        <header>
          <h3>Agregar Nuevo Estudiante</h3>
          <button class="close-btn" onclick="closeModal('addStudentModal')">√ó</button>
        </header>
        <div class="modal-body">
          <form id="addStudentForm">
            <div class="form-group">
              <label for="studentName">Nombre Completo</label>
              <input type="text" id="studentName" name="name" required>
            </div>
            <div class="form-group">
              <label for="studentEmail">Email</label>
              <input type="email" id="studentEmail" name="email" required>
            </div>
            <div class="form-group">
              <label for="studentPassword">Contrase√±a</label>
              <input type="password" id="studentPassword" name="password" required placeholder="M√≠nimo 6 caracteres">
            </div>
            <div class="form-group">
              <label for="studentMiles">Millas Iniciales</label>
              <input type="number" id="studentMiles" name="miles" value="0" min="0">
            </div>
            <div class="form-group">
              <label for="studentStatus">Estado</label>
              <select id="studentStatus" name="status">
                <option value="activo">Activo</option>
                <option value="pendiente">Pendiente</option>
                <option value="inactivo">Inactivo</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-actions">
          <button class="btn btn-outline" onclick="closeModal('addStudentModal')">Cancelar</button>
          <button class="btn" onclick="saveNewStudent()">Guardar Estudiante</button>
        </div>
      </div>
    </div>

    <!-- Modal para agregar kit -->
    <div class="modal-backdrop" id="addKitModal">
      <div class="modal">
        <header>
          <h3>Agregar Nuevo Kit</h3>
          <button class="close-btn" onclick="closeModal('addKitModal')">√ó</button>
        </header>
        <div class="modal-body">
          <form id="addKitForm">
            <div class="form-group">
              <label for="kitName">Nombre del Kit</label>
              <input type="text" id="kitName" name="name" required>
            </div>
            <div class="form-group">
              <label for="kitDescription">Descripci√≥n</label>
              <textarea id="kitDescription" name="description" rows="3" required></textarea>
            </div>
            <div class="form-group">
              <label for="kitPrice">Precio</label>
              <input type="number" id="kitPrice" name="price" min="0" step="0.01" required>
            </div>
            <div class="form-group">
              <label for="kitCategory">Categor√≠a</label>
              <select id="kitCategory" name="category" required>
                <option value="principiante">Principiante</option>
                <option value="intermedio">Intermedio</option>
                <option value="avanzado">Avanzado</option>
              </select>
            </div>
            <div class="form-group">
              <label for="kitPassword">Contrase√±a</label>
              <input type="text" id="kitPassword" name="password" required>
            </div>
            <div class="form-group">
              <label for="kitImage">URL de Imagen</label>
              <input type="url" id="kitImage" name="img" required>
            </div>
            <div class="form-group">
              <label for="kitVideo">URL de Video (opcional)</label>
              <input type="url" id="kitVideo" name="video">
            </div>
          </form>
        </div>
        <div class="modal-actions">
          <button class="btn btn-outline" onclick="closeModal('addKitModal')">Cancelar</button>
          <button class="btn" onclick="saveNewKit()">Guardar Kit</button>
        </div>
      </div>
    </div>

    <!-- Modal para editar estudiante -->
    <div class="modal-backdrop" id="editStudentModal">
      <div class="modal">
        <header>
          <h3>Editar Estudiante</h3>
          <button class="close-btn" onclick="closeModal('editStudentModal')">√ó</button>
        </header>
        <div class="modal-body">
          <form id="editStudentForm">
            <input type="hidden" id="editStudentId" name="id">
            <div class="form-group">
              <label for="editStudentName">Nombre Completo</label>
              <input type="text" id="editStudentName" name="name" required>
            </div>
            <div class="form-group">
              <label for="editStudentEmail">Email</label>
              <input type="email" id="editStudentEmail" name="email" required>
            </div>
            <div class="form-group">
              <label for="editStudentPassword">Contrase√±a</label>
              <input type="password" id="editStudentPassword" name="password" placeholder="Dejar vac√≠o para mantener la actual">
            </div>
            <div class="form-group">
              <label for="editStudentMiles">Millas</label>
              <input type="number" id="editStudentMiles" name="miles" min="0">
            </div>
            <div class="form-group">
              <label for="editStudentStatus">Estado</label>
              <select id="editStudentStatus" name="status">
                <option value="activo">Activo</option>
                <option value="pendiente">Pendiente</option>
                <option value="inactivo">Inactivo</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-actions">
          <button class="btn btn-outline" onclick="closeModal('editStudentModal')">Cancelar</button>
          <button class="btn" onclick="saveStudentEdit()">Guardar Cambios</button>
        </div>
      </div>
    </div>

    <!-- Modal para editar kit -->
    <div class="modal-backdrop" id="editKitModal">
      <div class="modal">
        <header>
          <h3>Editar Kit</h3>
          <button class="close-btn" onclick="closeModal('editKitModal')">√ó</button>
        </header>
        <div class="modal-body">
          <form id="editKitForm">
            <input type="hidden" id="editKitId" name="id">
            <div class="form-group">
              <label for="editKitName">Nombre del Kit</label>
              <input type="text" id="editKitName" name="name" required>
            </div>
            <div class="form-group">
              <label for="editKitDescription">Descripci√≥n</label>
              <textarea id="editKitDescription" name="description" rows="3" required></textarea>
            </div>
            <div class="form-group">
              <label for="editKitPrice">Precio</label>
              <input type="number" id="editKitPrice" name="price" min="0" step="0.01" required>
            </div>
            <div class="form-group">
              <label for="editKitCategory">Categor√≠a</label>
              <select id="editKitCategory" name="category" required>
                <option value="principiante">Principiante</option>
                <option value="intermedio">Intermedio</option>
                <option value="avanzado">Avanzado</option>
              </select>
            </div>
            <div class="form-group">
              <label for="editKitPassword">Contrase√±a</label>
              <input type="text" id="editKitPassword" name="password" required>
            </div>
            <div class="form-group">
              <label for="editKitImage">URL de Imagen</label>
              <input type="url" id="editKitImage" name="img" required>
            </div>
            <div class="form-group">
              <label for="editKitVideo">URL de Video (opcional)</label>
              <input type="url" id="editKitVideo" name="video">
            </div>
          </form>
        </div>
        <div class="modal-actions">
          <button class="btn btn-outline" onclick="closeModal('editKitModal')">Cancelar</button>
          <button class="btn" onclick="saveKitEdit()">Guardar Cambios</button>
        </div>
      </div>
    </div>

    <!-- Modal para agregar premio -->
    <div class="modal-backdrop" id="addRewardModal">
      <div class="modal">
        <header>
          <h3>Agregar Nuevo Premio</h3>
          <button class="close-btn" onclick="closeModal('addRewardModal')">√ó</button>
        </header>
        <div class="modal-body">
          <form id="addRewardForm">
            <div class="form-group">
              <label for="rewardName">Nombre del Premio</label>
              <input type="text" id="rewardName" name="name" required placeholder="Ej: Camiseta Croccon">
            </div>
            <div class="form-group">
              <label for="rewardDescription">Descripci√≥n</label>
              <input type="text" id="rewardDescription" name="description" required placeholder="Ej: Camiseta 100% algod√≥n">
            </div>
            <div class="form-group">
              <label for="rewardCost">Costo en Millas</label>
              <input type="number" id="rewardCost" name="cost" required placeholder="200" min="1">
            </div>
            <div class="form-group">
              <label for="rewardStock">Stock Disponible</label>
              <input type="number" id="rewardStock" name="stock" required placeholder="10" min="0">
            </div>
            <div class="form-group">
              <label for="rewardImage">Emoji/Icono</label>
              <input type="text" id="rewardImage" name="image" required placeholder="üëï" maxlength="2">
            </div>
          </form>
        </div>
        <div class="modal-actions">
          <button class="btn btn-outline" onclick="closeModal('addRewardModal')">Cancelar</button>
          <button class="btn" onclick="saveNewReward()">Guardar Premio</button>
        </div>
      </div>
    </div>

    <!-- Modal para editar premio -->
    <div class="modal-backdrop" id="editRewardModal">
      <div class="modal">
        <header>
          <h3>Editar Premio</h3>
          <button class="close-btn" onclick="closeModal('editRewardModal')">√ó</button>
        </header>
        <div class="modal-body">
          <form id="editRewardForm">
            <input type="hidden" id="editRewardId" name="id">
            <div class="form-group">
              <label for="editRewardName">Nombre del Premio</label>
              <input type="text" id="editRewardName" name="name" required>
            </div>
            <div class="form-group">
              <label for="editRewardDescription">Descripci√≥n</label>
              <input type="text" id="editRewardDescription" name="description" required>
            </div>
            <div class="form-group">
              <label for="editRewardCost">Costo en Millas</label>
              <input type="number" id="editRewardCost" name="cost" required min="1">
            </div>
            <div class="form-group">
              <label for="editRewardStock">Stock Disponible</label>
              <input type="number" id="editRewardStock" name="stock" required min="0">
            </div>
            <div class="form-group">
              <label for="editRewardImage">Emoji/Icono</label>
              <input type="text" id="editRewardImage" name="image" required maxlength="2">
            </div>
          </form>
        </div>
        <div class="modal-actions">
          <button class="btn btn-outline" onclick="closeModal('editRewardModal')">Cancelar</button>
          <button class="btn" onclick="saveRewardEdit()">Guardar Cambios</button>
        </div>
      </div>
    </div>
  </body>
</html>
