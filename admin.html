<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel de Administraci√≥n - Croccon Academia de Rob√≥tica</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="assets/css/styles.css" />
  </head>
  <body>
    <header class="topbar">
      <div class="container nav">
        <a class="brand" href="index.html">Croccon</a>
        <button class="hamburger" id="navToggle" aria-label="Abrir men√∫">‚ò∞</button>
        <nav id="mainNav">
          <!-- El contenido se generar√° din√°micamente -->
        </nav>
      </div>
    </header>

    <main>
      <section class="page-header">
        <div class="container">
          <h1>Panel de Administraci√≥n</h1>
          <p>Gestiona estudiantes, contenidos y reportes</p>
        </div>
      </section>

      <section class="admin-content">
        <div class="container">
          <!-- Pesta√±as de administraci√≥n -->
        <div class="admin-tabs">
          <button class="tab-btn active" data-tab="students">Estudiantes</button>
          <button class="tab-btn" data-tab="content">Contenido</button>
          <button class="tab-btn" data-tab="reports">Reportes</button>
          <button class="tab-btn" data-tab="messages">Mensajes</button>
          <button class="tab-btn" data-tab="redemptions">Canjes</button>
          <button class="tab-btn" data-tab="rewards">Premios</button>
        </div>

          <!-- Tab: Estudiantes -->
          <div class="tab-content active" id="students">
            <h2>Gesti√≥n de Estudiantes</h2>
            <div class="admin-actions">
              <button class="btn" onclick="showAddStudentForm()">Agregar Estudiante</button>
              <button class="btn btn-outline" onclick="exportStudents()">Exportar Lista</button>
            </div>
            
            <div class="students-table">
              <table>
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>Email</th>
                    <th>Millas</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="studentsTableBody">
                  <!-- Los estudiantes se cargar√°n din√°micamente -->
                </tbody>
              </table>
            </div>
          </div>

          <!-- Tab: Contenido -->
          <div class="tab-content" id="content">
            <h2>Gesti√≥n de Contenido</h2>
            <div class="content-upload">
              <h3>Subir Nuevo Contenido</h3>
              <form id="contentForm">
                <div class="form-group">
                  <label>Tipo de Contenido</label>
                  <select id="contentType" required>
                    <option value="">Seleccionar tipo</option>
                    <option value="video">Video</option>
                    <option value="guia">Gu√≠a</option>
                    <option value="reporte">Reporte</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Asociar a Kit</label>
                  <select id="contentKit">
                    <option value="">Ninguno</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>T√≠tulo</label>
                  <input type="text" id="contentTitle" required>
                </div>
                <div class="form-group">
                  <label>Descripci√≥n</label>
                  <textarea id="contentDescription" rows="3"></textarea>
                </div>
                <div class="form-group">
                  <label>URL del Video (opcional)</label>
                  <input type="url" id="contentUrl">
                </div>
                <button type="submit" class="btn">Subir Contenido</button>
              </form>
            </div>
            
            <div class="content-list">
              <h3>Contenido Subido</h3>
              <div id="contentList">
                <!-- El contenido se cargar√° din√°micamente -->
              </div>
            </div>
          </div>

          <!-- Tab: Reportes -->
          <div class="tab-content" id="reports">
            <h2>Reportes y Estad√≠sticas</h2>
            <div class="stats-grid">
              <div class="stat-card">
                <h3>Total Estudiantes</h3>
                <div class="stat-number" id="totalStudents">0</div>
              </div>
              <div class="stat-card">
                <h3>Millas Otorgadas</h3>
                <div class="stat-number" id="totalMiles">0</div>
              </div>
              <div class="stat-card">
                <h3>Canjes Realizados</h3>
                <div class="stat-number" id="totalRedemptions">0</div>
              </div>
              <div class="stat-card">
                <h3>Mensajes Recibidos</h3>
                <div class="stat-number" id="totalMessages">0</div>
              </div>
            </div>
          </div>

          <!-- Tab: Mensajes -->
          <div class="tab-content" id="messages">
            <h2>Mensajes de Contacto</h2>
            <div id="messagesList">
              <!-- Los mensajes se cargar√°n din√°micamente -->
            </div>
          </div>

          <!-- Tab: Canjes -->
          <div class="tab-content" id="redemptions">
            <h2>Canjes de Puntos</h2>
            <div id="redemptionsList">
              <!-- Los canjes se cargar√°n din√°micamente -->
            </div>
          </div>

          <!-- Tab: Premios F√≠sicos -->
          <div class="tab-content" id="rewards">
            <h2>Gesti√≥n de Premios F√≠sicos</h2>
            <div class="rewards-upload">
              <h3>Agregar Nuevo Premio</h3>
              <form id="rewardForm">
                <div class="form-group">
                  <label>Nombre del Premio</label>
                  <input type="text" id="rewardName" required placeholder="Ej: Camiseta Croccon">
                </div>
                <div class="form-group">
                  <label>Descripci√≥n</label>
                  <input type="text" id="rewardDescription" required placeholder="Ej: Camiseta 100% algod√≥n">
                </div>
                <div class="form-group">
                  <label>Costo en Millas</label>
                  <input type="number" id="rewardCost" required placeholder="200" min="1">
                </div>
                <div class="form-group">
                  <label>Stock Disponible</label>
                  <input type="number" id="rewardStock" required placeholder="10" min="0">
                </div>
                <div class="form-group">
                  <label>Emoji/Icono</label>
                  <input type="text" id="rewardImage" required placeholder="üëï" maxlength="2">
                </div>
                <button type="submit" class="btn">Agregar Premio</button>
              </form>
            </div>
            
            <div class="rewards-list">
              <h3>Premios Disponibles</h3>
              <div id="rewardsList">
                <!-- Los premios se cargar√°n din√°micamente -->
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Modal Editar Estudiante -->
      <div class="modal-backdrop" id="editModal">
        <div class="modal">
          <header>
            <h3>Editar Estudiante</h3>
            <button class="btn btn-sm btn-outline" onclick="closeEditModal()">Cerrar</button>
          </header>
          <div class="modal-body">
            <form id="editStudentForm">
              <input type="hidden" id="editId">
              <div class="form-group">
                <label>Nombre</label>
                <input type="text" id="editName" required>
              </div>
              <div class="form-group">
                <label>Email</label>
                <input type="email" id="editEmail" required>
              </div>
              <div class="form-group">
                <label>Millas</label>
                <input type="number" id="editMiles" min="0" step="1">
              </div>
            </form>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-outline" onclick="closeEditModal()">Cancelar</button>
            <button type="submit" form="editStudentForm" class="btn">Guardar</button>
          </div>
        </div>
      </div>
    </main>

    <footer class="footer">
      <div class="container foot-grid">
        <div>
          <strong>Croccon</strong>
          <p>Buy One. Plant one.</p>
        </div>
        <div class="right">
          <span>S√≠guenos</span>
          <div class="dots"></div>
        </div>
      </div>
    </footer>

    <script src="assets/js/data.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/app.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Verificar autenticaci√≥n de admin
        const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
        if (!currentUser || currentUser.role !== 'admin') {
          // Para testing en Netlify, crear un admin por defecto si no existe
          if (!currentUser) {
            const defaultAdmin = {
              id: 'admin-1',
              name: 'Administrador',
              email: 'admin@croccon.edu',
              role: 'admin'
            };
            localStorage.setItem('currentUser', JSON.stringify(defaultAdmin));
            // Recargar la p√°gina para aplicar los cambios
            window.location.reload();
            return;
          }
          window.location.href = 'login.html';
          return;
        }
        
        // Inicializar pesta√±as
        initTabs();
        
        // Cargar datos iniciales
        loadStudents();
        loadContent();
        loadReports();
        loadMessages();
        loadRedemptions();
        loadRewards();
        
        // Asegurar que el header se configure correctamente
        setTimeout(function() {
          if (typeof window.setupHeaderByRole === 'function') {
            window.setupHeaderByRole();
          }
        }, 200);
      });
      
      function initTabs() {
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        
        tabBtns.forEach(btn => {
          btn.addEventListener('click', () => {
            const tabId = btn.dataset.tab;
            
            tabBtns.forEach(b => b.classList.remove('active'));
            tabContents.forEach(c => c.classList.remove('active'));
            
            btn.classList.add('active');
            document.getElementById(tabId).classList.add('active');
          });
        });
      }
      
      function loadStudents() {
        const users = JSON.parse(localStorage.getItem('users') || '[]');
        const students = users.filter(u => u.role === 'estudiante');
        
        const tbody = document.getElementById('studentsTableBody');
        tbody.innerHTML = students.map(student => `
          <tr>
            <td>${student.name}</td>
            <td>${student.email}</td>
            <td>${student.miles || 0}</td>
            <td><span class="status active">Activo</span></td>
            <td>
              <button class="btn btn-sm" onclick="editStudent('${student.id}')">Editar</button>
              <button class="btn btn-sm btn-outline" onclick="viewStudent('${student.id}')">Ver</button>
            </td>
          </tr>
        `).join('');
      }
      
      function loadContent() {
        const content = JSON.parse(localStorage.getItem('content') || '[]');
        const contentList = document.getElementById('contentList');
        
        contentList.innerHTML = content.map(item => `
          <div class="content-item">
            <h4>${item.title}</h4>
            <p>${item.description}</p>
            <span class="content-type">${item.type}${item.kitId ? ' ¬∑ Kit: ' + item.kitId : ''}</span>
            <span class="content-date">${item.date}</span>
          </div>
        `).join('');
      }
      
      function loadReports() {
        const users = JSON.parse(localStorage.getItem('users') || '[]');
        const students = users.filter(u => u.role === 'estudiante');
        const totalMiles = students.reduce((sum, s) => sum + (s.miles || 0), 0);
        const redemptions = JSON.parse(localStorage.getItem('redemptions') || '[]');
        const messages = JSON.parse(localStorage.getItem('contactMessages') || '[]');
        
        document.getElementById('totalStudents').textContent = students.length;
        document.getElementById('totalMiles').textContent = totalMiles;
        document.getElementById('totalRedemptions').textContent = redemptions.length;
        document.getElementById('totalMessages').textContent = messages.length;
      }
      
      function loadMessages() {
        const messages = JSON.parse(localStorage.getItem('contactMessages') || '[]');
        const messagesList = document.getElementById('messagesList');
        
        messagesList.innerHTML = messages.map(msg => `
          <div class="message-item">
            <h4>${msg.asunto} - ${msg.nombre}</h4>
            <p><strong>Email:</strong> ${msg.email}</p>
            <p><strong>Fecha:</strong> ${msg.fecha}</p>
            <p>${msg.mensaje}</p>
            <div class="message-actions">
              <button class="btn btn-sm" onclick="replyMessage('${msg.id}')">Responder</button>
              <button class="btn btn-sm btn-outline" onclick="markAsRead('${msg.id}')">Marcar como le√≠do</button>
            </div>
          </div>
        `).join('');
      }
      
      function loadRedemptions() {
        const redemptions = JSON.parse(localStorage.getItem('redemptions') || '[]');
        const redemptionsList = document.getElementById('redemptionsList');
        
        redemptionsList.innerHTML = redemptions.map(redemption => `
          <div class="redemption-item">
            <h4>${redemption.rewardName}</h4>
            <p><strong>Costo:</strong> ${redemption.cost} millas</p>
            <p><strong>Fecha:</strong> ${redemption.date}</p>
            <p><strong>Estado:</strong> <span class="status ${redemption.status}">${redemption.status}</span></p>
            <div class="redemption-actions">
              <button class="btn btn-sm" onclick="approveRedemption('${redemption.id}')">Aprobar</button>
              <button class="btn btn-sm btn-outline" onclick="rejectRedemption('${redemption.id}')">Rechazar</button>
            </div>
          </div>
        `).join('');
      }
      
      function showAddStudentForm() {
        const name = prompt('Nombre del estudiante:');
        const email = prompt('Email del estudiante:');
        if (name && email) {
          const users = JSON.parse(localStorage.getItem('users') || '[]');
          const newStudent = {
            id: Date.now().toString(),
            name: name,
            email: email,
            username: email,
            password: 'estudiante123',
            role: 'estudiante',
            miles: 0
          };
          users.push(newStudent);
          localStorage.setItem('users', JSON.stringify(users));
          loadStudents();
          alert('Estudiante agregado correctamente');
        }
      }
      
      function editStudent(studentId) {
        const users = JSON.parse(localStorage.getItem('users') || '[]');
        const s = users.find(u => u.id === studentId);
        if (!s) return;
        document.getElementById('editId').value = s.id;
        document.getElementById('editName').value = s.name;
        document.getElementById('editEmail').value = s.email;
        document.getElementById('editMiles').value = s.miles || 0;
        document.getElementById('editModal').classList.add('show');
      }

      function closeEditModal(){
        document.getElementById('editModal').classList.remove('show');
      }

      function saveStudentEdits(){
        const id = document.getElementById('editId').value;
        const name = document.getElementById('editName').value.trim();
        const email = document.getElementById('editEmail').value.trim();
        const miles = parseInt(document.getElementById('editMiles').value,10) || 0;
        if(!name || !email){ alert('Completa nombre y email'); return; }
        const users = JSON.parse(localStorage.getItem('users') || '[]');
        const idx = users.findIndex(u => u.id === id);
        if (idx === -1) return;
        users[idx] = { ...users[idx], name, email, miles };
        localStorage.setItem('users', JSON.stringify(users));
        loadStudents();
        closeEditModal();
        alert('Estudiante actualizado');
      }
      
      function viewStudent(studentId) {
        alert(`Viendo estudiante ${studentId}`);
      }
      
      function exportStudents() {
        const users = JSON.parse(localStorage.getItem('users') || '[]');
        const students = users.filter(u => u.role === 'estudiante');
        const csv = 'Nombre,Email,Millas\n' + students.map(s => `${s.name},${s.email},${s.miles || 0}`).join('\n');
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'estudiantes.csv';
        a.click();
      }
      
      function replyMessage(messageId) {
        alert(`Respondiendo mensaje ${messageId}`);
      }
      
      function markAsRead(messageId) {
        alert(`Mensaje ${messageId} marcado como le√≠do`);
      }
      
      function approveRedemption(redemptionId) {
        const redemptions = JSON.parse(localStorage.getItem('redemptions') || '[]');
        const redemption = redemptions.find(r => r.id == redemptionId);
        if (redemption) {
          redemption.status = 'aprobado';
          localStorage.setItem('redemptions', JSON.stringify(redemptions));
          loadRedemptions();
          alert('Canje aprobado');
        }
      }
      
      function rejectRedemption(redemptionId) {
        const redemptions = JSON.parse(localStorage.getItem('redemptions') || '[]');
        const redemption = redemptions.find(r => r.id == redemptionId);
        if (redemption) {
          redemption.status = 'rechazado';
          localStorage.setItem('redemptions', JSON.stringify(redemptions));
          loadRedemptions();
          alert('Canje rechazado');
        }
      }
      
      function logout() {
        localStorage.removeItem('currentUser');
        window.location.href = 'login.html';
      }
      
      // Funci√≥n global para logout desde el header
      window.logout = logout;
      
      // Formulario de contenido
      const contentFormEl = document.getElementById('contentForm');
      if (contentFormEl) {
        contentFormEl.addEventListener('submit', function(e) {
          e.preventDefault();
          const content = {
            id: Date.now().toString(),
            type: document.getElementById('contentType').value,
            title: document.getElementById('contentTitle').value,
            description: document.getElementById('contentDescription').value,
            url: document.getElementById('contentUrl').value,
            date: new Date().toLocaleString('es-ES'),
            kitId: document.getElementById('contentKit').value
          };
          const contents = JSON.parse(localStorage.getItem('content') || '[]');
          contents.push(content);
          localStorage.setItem('content', JSON.stringify(contents));
          alert('Contenido subido correctamente');
          loadContent();
          this.reset();
        });
      }

      // Manejar submit del modal de edici√≥n
      const editFormEl = document.getElementById('editStudentForm');
      if (editFormEl) {
        editFormEl.addEventListener('submit', function(e){
          e.preventDefault();
          saveStudentEdits();
        });
      }

      // Poblar select de kits
      (function fillKits(){
        const select = document.getElementById('contentKit');
        if (!select || !window.CROC_DATA) return;
        window.CROC_DATA.products.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.id; opt.textContent = p.name; select.appendChild(opt);
        });
      })();
    </script>
  </body>
</html>
