<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Croccon Academia de Rob√≥tica</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="assets/css/styles.css" />
  </head>
  <body>
    <header class="topbar">
      <div class="container nav">
        <a class="brand" href="index.html">Croccon</a>
        <button class="hamburger" id="navToggle" aria-label="Abrir men√∫">‚ò∞</button>
        <nav id="mainNav">
          <a href="index.html">Inicio</a>
          <a href="tienda.html">Tienda</a>
          <a href="galeria.html">Galer√≠a</a>
          <a href="contacto.html">Contacto</a>
          <a href="login.html" class="btn btn-sm">Ingresar</a>
        </nav>
      </div>
    </header>

    <main>
      <section class="page-header">
        <div class="container">
          <h1>¬°Bienvenido, <span id="userName">Estudiante</span>!</h1>
          <p>Tu centro de aprendizaje y logros</p>
        </div>
      </section>

      <section class="dashboard-content">
        <div class="container">
          <!-- Puntos y Millas -->
          <div class="stats-grid">
            <div class="stat-card">
              <h3>Millas Acumuladas</h3>
              <div class="stat-number" id="totalMiles">0</div>
              <p>Puntos disponibles para canjear</p>
            </div>
            <div class="stat-card">
              <h3>Cursos Completados</h3>
              <div class="stat-number" id="completedCourses">0</div>
              <p>De 12 cursos disponibles</p>
            </div>
            <div class="stat-card">
              <h3>Videos Vistos</h3>
              <div class="stat-number" id="videosWatched">0</div>
              <p>Contenido educativo consumido</p>
            </div>
          </div>

          <!-- Acciones R√°pidas -->
          <div class="quick-actions">
            <h2>Acciones R√°pidas</h2>
            <div class="actions-grid">
              <button class="action-btn" onclick="earnMiles('video')">
                <span class="action-icon">üìπ</span>
                <span>Ver Video (+10 millas)</span>
              </button>
              <button class="action-btn" onclick="earnMiles('guide')">
                <span class="action-icon">üìñ</span>
                <span>Completar Gu√≠a (+15 millas)</span>
              </button>
              <button class="action-btn" onclick="earnMiles('project')">
                <span class="action-icon">üîß</span>
                <span>Subir Proyecto (+25 millas)</span>
              </button>
              <button class="action-btn" onclick="window.location.href='#redeem'">
                <span class="action-icon">üéÅ</span>
                <span>Canjear Puntos</span>
              </button>
            </div>
          </div>

          <!-- Mapa de Misiones -->
          <div class="visualization-section">
            <h2>Tu mapa de misiones</h2>
            <div class="miles-constellation">
              <canvas id="milesMap"></canvas>
            </div>
            <div class="miles-legend">
              <div class="dot-sample"></div>
              <span>Cada estaci√≥n representa una misi√≥n completada en tu viaje de aprendizaje</span>
            </div>
          </div>

          <!-- Cursos Disponibles -->
          <div class="courses-section">
            <h2>Mis Cursos</h2>
            <div class="courses-grid" id="coursesGrid">
              <!-- Los cursos se cargar√°n din√°micamente -->
            </div>
          </div>

          <!-- Canje de Puntos -->
          <div class="redeem-section" id="redeem">
            <h2>Canjear Puntos</h2>
            <div class="rewards-grid" id="rewardsGrid">
              <!-- Las recompensas se cargar√°n din√°micamente -->
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer class="footer">
      <div class="container foot-grid">
        <div>
          <strong>Croccon</strong>
          <p>Buy One. Plant one.</p>
        </div>
        <div class="right">
          <span>S√≠guenos</span>
          <div class="dots"></div>
        </div>
      </div>
    </footer>

    <script src="assets/js/data.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/app.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Verificar autenticaci√≥n
        const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
        if (!currentUser || currentUser.role === 'admin') {
          window.location.href = 'login.html';
          return;
        }
        
        // Mostrar nombre del usuario
        document.getElementById('userName').textContent = currentUser.name;
        
        // Cargar datos del dashboard
        loadDashboardData();
        loadCourses();
        loadRewards();
      });
      
      function loadDashboardData() {
        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
        const miles = userData.miles || 0;
        const completedCourses = userData.completedCourses || 0;
        const videosWatched = userData.videosWatched || 0;
        
        document.getElementById('totalMiles').textContent = miles;
        document.getElementById('completedCourses').textContent = completedCourses;
        document.getElementById('videosWatched').textContent = videosWatched;

        drawMilesConstellation();
        // Redibujar al cambiar tama√±o para mantener nitidez
        let resizeTimer;
        window.addEventListener('resize', () => {
          clearTimeout(resizeTimer);
          resizeTimer = setTimeout(drawMilesConstellation, 150);
        });
      }
      
      function loadCourses() {
        const courses = [
          { id: 1, title: 'Introducci√≥n a la Rob√≥tica', progress: 75, status: 'en_curso' },
          { id: 2, title: 'Programaci√≥n B√°sica', progress: 100, status: 'completado' },
          { id: 3, title: 'Sensores y Actuadores', progress: 30, status: 'en_curso' },
          { id: 4, title: 'Proyectos Avanzados', progress: 0, status: 'disponible' }
        ];
        
        const coursesGrid = document.getElementById('coursesGrid');
        coursesGrid.innerHTML = courses.map(course => `
          <div class="course-card ${course.status}">
            <h3>${course.title}</h3>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${course.progress}%"></div>
            </div>
            <p>${course.progress}% completado</p>
            <button class="btn btn-sm" onclick="continueCourse(${course.id})">
              ${course.status === 'completado' ? 'Revisar' : 'Continuar'}
            </button>
          </div>
        `).join('');
      }

      // Visualizaci√≥n: mapa de misiones
      function drawMilesConstellation(){
        const canvas = document.getElementById('milesMap');
        if(!canvas) return;
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.parentElement.getBoundingClientRect();
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        const ctx = canvas.getContext('2d');
        ctx.scale(dpr,dpr);
        
        // Detectar si es m√≥vil
        const isMobile = window.innerWidth <= 768;
        const isSmallMobile = window.innerWidth <= 480;
        
        // Limpiar canvas
        ctx.clearRect(0,0,rect.width,rect.height);
        
        // Obtener datos del usuario
        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
        const miles = userData.miles || 0;
        
        // Definir misiones progresivas
        const missions = [
          { 
            id: 1, 
            name: "Primer Paso", 
            description: "Completa tu primer video",
            x: 0.1, 
            y: 0.5, 
            requiredMiles: 0,
            reward: 10,
            icon: "üé¨"
          },
          { 
            id: 2, 
            name: "Constructor", 
            description: "Construye tu primer robot",
            x: 0.25, 
            y: 0.3, 
            requiredMiles: 20,
            reward: 15,
            icon: "ü§ñ"
          },
          { 
            id: 3, 
            name: "Programador", 
            description: "Aprende programaci√≥n b√°sica",
            x: 0.4, 
            y: 0.6, 
            requiredMiles: 40,
            reward: 20,
            icon: "üíª"
          },
          { 
            id: 4, 
            name: "Sensor Master", 
            description: "Domina los sensores",
            x: 0.55, 
            y: 0.25, 
            requiredMiles: 70,
            reward: 25,
            icon: "üì°"
          },
          { 
            id: 5, 
            name: "Innovador", 
            description: "Crea tu primer proyecto",
            x: 0.7, 
            y: 0.45, 
            requiredMiles: 100,
            reward: 30,
            icon: "‚ö°"
          },
          { 
            id: 6, 
            name: "Experto", 
            description: "Completa un proyecto avanzado",
            x: 0.85, 
            y: 0.35, 
            requiredMiles: 150,
            reward: 50,
            icon: "üèÜ"
          },
          { 
            id: 7, 
            name: "Maestro", 
            description: "Ense√±a a otros estudiantes",
            x: 0.95, 
            y: 0.6, 
            requiredMiles: 200,
            reward: 75,
            icon: "üë®‚Äçüè´"
          }
        ];
        
        // Determinar misiones desbloqueadas
        const unlockedMissions = missions.filter(mission => miles >= mission.requiredMiles);
        const nextMission = missions.find(mission => miles < mission.requiredMiles);
        
        // Dibujar carretera principal
        ctx.strokeStyle = '#ffffff';
        ctx.lineWidth = isSmallMobile ? 8 : (isMobile ? 10 : 12);
        ctx.lineCap = 'round';
        ctx.beginPath();
        ctx.moveTo(0.05 * rect.width, 0.5 * rect.height);
        ctx.quadraticCurveTo(0.2 * rect.width, 0.4 * rect.height, 0.4 * rect.width, 0.5 * rect.height);
        ctx.quadraticCurveTo(0.6 * rect.width, 0.35 * rect.height, 0.8 * rect.width, 0.4 * rect.height);
        ctx.quadraticCurveTo(0.9 * rect.width, 0.5 * rect.height, 0.95 * rect.width, 0.55 * rect.height);
        ctx.stroke();
        
        // Dibujar l√≠neas de la carretera
        ctx.strokeStyle = '#ffd700';
        ctx.lineWidth = isSmallMobile ? 2 : (isMobile ? 3 : 4);
        ctx.setLineDash(isSmallMobile ? [8, 8] : (isMobile ? [12, 12] : [15, 15]));
        ctx.beginPath();
        ctx.moveTo(0.05 * rect.width, 0.5 * rect.height);
        ctx.quadraticCurveTo(0.2 * rect.width, 0.4 * rect.height, 0.4 * rect.width, 0.5 * rect.height);
        ctx.quadraticCurveTo(0.6 * rect.width, 0.35 * rect.height, 0.8 * rect.width, 0.4 * rect.height);
        ctx.quadraticCurveTo(0.9 * rect.width, 0.5 * rect.height, 0.95 * rect.width, 0.55 * rect.height);
        ctx.stroke();
        ctx.setLineDash([]);
        
        // Dibujar misiones desbloqueadas
        unlockedMissions.forEach((mission, index) => {
          const x = mission.x * rect.width;
          const y = mission.y * rect.height;
          const size = isSmallMobile ? 15 : (isMobile ? 20 : 25);
          
          // Halo de la estaci√≥n
          const halo = ctx.createRadialGradient(x, y, 0, x, y, size * 2.5);
          halo.addColorStop(0, 'rgba(0, 255, 0, 0.6)');
          halo.addColorStop(0.7, 'rgba(0, 200, 0, 0.3)');
          halo.addColorStop(1, 'rgba(0, 200, 0, 0)');
          
          ctx.fillStyle = halo;
          ctx.beginPath();
          ctx.arc(x, y, size * 2, 0, Math.PI * 2);
          ctx.fill();
          
          // Estaci√≥n completada
          ctx.fillStyle = '#00ff00';
          ctx.beginPath();
          ctx.arc(x, y, size, 0, Math.PI * 2);
          ctx.fill();
          
          // Borde de la estaci√≥n
          ctx.strokeStyle = '#ffffff';
          ctx.lineWidth = isSmallMobile ? 2 : (isMobile ? 3 : 4);
          ctx.beginPath();
          ctx.arc(x, y, size, 0, Math.PI * 2);
          ctx.stroke();
          
          // Icono de la misi√≥n
          ctx.fillStyle = '#ffffff';
          ctx.font = isSmallMobile ? 'bold 12px Arial' : (isMobile ? 'bold 16px Arial' : 'bold 20px Arial');
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(mission.icon, x, y);
          
          // Nombre de la misi√≥n (solo en pantallas grandes)
          if (!isSmallMobile) {
            ctx.fillStyle = '#ffffff';
            ctx.font = isMobile ? 'bold 10px Poppins' : 'bold 14px Poppins';
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = isMobile ? 2 : 3;
            ctx.strokeText(mission.name, x, y - size - 12);
            ctx.fillText(mission.name, x, y - size - 12);
          }
        });
        
        // Dibujar pr√≥xima misi√≥n (si existe)
        if (nextMission) {
          const x = nextMission.x * rect.width;
          const y = nextMission.y * rect.height;
          const size = 25;
          
          // Halo de la pr√≥xima misi√≥n (parpadeante)
          const pulse = 1 + Math.sin(Date.now() * 0.005) * 0.3;
          const halo = ctx.createRadialGradient(x, y, 0, x, y, size * 2.5 * pulse);
          halo.addColorStop(0, 'rgba(255, 255, 0, 0.6)');
          halo.addColorStop(0.7, 'rgba(255, 200, 0, 0.3)');
          halo.addColorStop(1, 'rgba(255, 200, 0, 0)');
          
          ctx.fillStyle = halo;
          ctx.beginPath();
          ctx.arc(x, y, size * 2 * pulse, 0, Math.PI * 2);
          ctx.fill();
          
          // Pr√≥xima estaci√≥n
          ctx.fillStyle = '#ffff00';
          ctx.beginPath();
          ctx.arc(x, y, size, 0, Math.PI * 2);
          ctx.fill();
          
          // Borde de la pr√≥xima estaci√≥n
          ctx.strokeStyle = '#ffffff';
          ctx.lineWidth = 4;
          ctx.beginPath();
          ctx.arc(x, y, size, 0, Math.PI * 2);
          ctx.stroke();
          
          // Icono de la pr√≥xima misi√≥n
          ctx.fillStyle = '#000000';
          ctx.font = 'bold 20px Arial';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(nextMission.icon, x, y);
          
          // Nombre de la pr√≥xima misi√≥n
          ctx.fillStyle = '#ffff00';
          ctx.font = 'bold 14px Poppins';
          ctx.strokeStyle = '#000000';
          ctx.lineWidth = 3;
          ctx.strokeText(nextMission.name, x, y - size - 12);
          ctx.fillText(nextMission.name, x, y - size - 12);
          
          // Requisitos de millas
          ctx.fillStyle = '#ffffff';
          ctx.font = 'bold 12px Poppins';
          ctx.strokeStyle = '#000000';
          ctx.lineWidth = 2;
          ctx.strokeText(`${nextMission.requiredMiles} millas`, x, y + size + 12);
          ctx.fillText(`${nextMission.requiredMiles} millas`, x, y + size + 12);
        }
        
        // Dibujar misiones bloqueadas
        const lockedMissions = missions.filter(mission => miles < mission.requiredMiles && mission !== nextMission);
        lockedMissions.forEach(mission => {
          const x = mission.x * rect.width;
          const y = mission.y * rect.height;
          const size = 20;
          
          // Estaci√≥n bloqueada
          ctx.fillStyle = '#444444';
          ctx.beginPath();
          ctx.arc(x, y, size, 0, Math.PI * 2);
          ctx.fill();
          
          // Borde de la estaci√≥n bloqueada
          ctx.strokeStyle = '#666666';
          ctx.lineWidth = 3;
          ctx.beginPath();
          ctx.arc(x, y, size, 0, Math.PI * 2);
          ctx.stroke();
          
          // Icono bloqueado
          ctx.fillStyle = '#666666';
          ctx.font = 'bold 16px Arial';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText('üîí', x, y);
        });
        
        // Mostrar progreso actual
        const progress = Math.min(100, (miles / 200) * 100);
        
        // Fondo para el texto de progreso
        ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
        ctx.fillRect(15, 15, 300, 100);
        
        // Texto de progreso con mejor contraste
        ctx.fillStyle = '#ffffff';
        ctx.font = 'bold 16px Poppins';
        ctx.textAlign = 'left';
        ctx.strokeStyle = '#000000';
        ctx.lineWidth = 2;
        ctx.strokeText(`Progreso: ${Math.round(progress)}%`, 25, 35);
        ctx.fillText(`Progreso: ${Math.round(progress)}%`, 25, 35);
        
        ctx.strokeText(`Millas: ${miles}`, 25, 55);
        ctx.fillText(`Millas: ${miles}`, 25, 55);
        
        if (nextMission) {
          ctx.strokeText(`Siguiente: ${nextMission.name}`, 25, 75);
          ctx.fillText(`Siguiente: ${nextMission.name}`, 25, 75);
          ctx.strokeText(`Necesitas: ${nextMission.requiredMiles - miles} millas m√°s`, 25, 95);
          ctx.fillText(`Necesitas: ${nextMission.requiredMiles - miles} millas m√°s`, 25, 95);
        } else {
          ctx.strokeText('¬°Felicidades! Has completado todas las misiones', 25, 75);
          ctx.fillText('¬°Felicidades! Has completado todas las misiones', 25, 75);
        }
      }
      
      function loadRewards() {
        // Cargar premios desde localStorage (gestionados por admin)
        const rewards = JSON.parse(localStorage.getItem('physicalRewards') || '[]');
        
        // Si no hay premios, crear algunos por defecto
        if (rewards.length === 0) {
          const defaultRewards = [
            { id: 1, name: 'Sticker Pack Croccon', cost: 50, stock: 20, description: 'Pack de 10 stickers tem√°ticos', image: 'üé®' },
            { id: 2, name: 'L√°piz Personalizado', cost: 100, stock: 15, description: 'L√°piz con logo de Croccon', image: '‚úèÔ∏è' },
            { id: 3, name: 'Camiseta Croccon', cost: 200, stock: 8, description: 'Camiseta 100% algod√≥n', image: 'üëï' },
            { id: 4, name: 'Kit Arduino B√°sico', cost: 500, stock: 5, description: 'Kit completo para principiantes', image: 'üîß' },
            { id: 5, name: 'Libro de Rob√≥tica', cost: 300, stock: 12, description: 'Gu√≠a completa de rob√≥tica', image: 'üìö' },
            { id: 6, name: 'Mochila Croccon', cost: 400, stock: 6, description: 'Mochila resistente para kits', image: 'üéí' }
          ];
          localStorage.setItem('physicalRewards', JSON.stringify(defaultRewards));
          loadRewards(); // Recargar con los premios por defecto
          return;
        }
        
        const rewardsGrid = document.getElementById('rewardsGrid');
        rewardsGrid.innerHTML = rewards.map(reward => {
          const isAvailable = reward.stock > 0;
          const userMiles = JSON.parse(localStorage.getItem('userData') || '{}').miles || 0;
          const canAfford = userMiles >= reward.cost;
          const canRedeem = isAvailable && canAfford;
          
          return `
            <div class="reward-card ${!canRedeem ? 'unavailable' : ''}">
              <div class="reward-image">${reward.image}</div>
              <h3>${reward.name}</h3>
              <p class="reward-description">${reward.description}</p>
              <div class="reward-cost">${reward.cost} millas</div>
              <div class="reward-stock">Stock: ${reward.stock} unidades</div>
              <button class="btn btn-sm" ${!canRedeem ? 'disabled' : ''} 
                      onclick="redeemReward(${reward.id})">
                ${!isAvailable ? 'Sin Stock' : !canAfford ? 'Millas Insuficientes' : 'Canjear'}
              </button>
            </div>
          `;
        }).join('');
      }
      
      function earnMiles(action) {
        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
        const miles = userData.miles || 0;
        let earned = 0;
        
        switch(action) {
          case 'video': earned = 10; break;
          case 'guide': earned = 15; break;
          case 'project': earned = 25; break;
        }
        
        userData.miles = miles + earned;
        localStorage.setItem('userData', JSON.stringify(userData));
        
        alert(`¬°Ganaste ${earned} millas! Total: ${userData.miles}`);
        loadDashboardData();
      }
      
      function redeemReward(rewardId) {
        const rewards = JSON.parse(localStorage.getItem('physicalRewards') || '[]');
        const reward = rewards.find(r => r.id === rewardId);
        
        if (!reward) {
          alert('Premio no encontrado');
          return;
        }
        
        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
        const miles = userData.miles || 0;
        
        // Verificar stock
        if (reward.stock <= 0) {
          alert('Este premio no est√° disponible en este momento');
          return;
        }
        
        // Verificar millas suficientes
        if (miles < reward.cost) {
          alert(`No tienes suficientes millas. Necesitas ${reward.cost} millas, tienes ${miles}`);
          return;
        }
        
        // Confirmar canje
        if (!confirm(`¬øConfirmas el canje de ${reward.name} por ${reward.cost} millas?`)) {
          return;
        }
        
        // Procesar canje
        userData.miles = miles - reward.cost;
        localStorage.setItem('userData', JSON.stringify(userData));
        
        // Reducir stock
        reward.stock = reward.stock - 1;
        const updatedRewards = rewards.map(r => r.id === rewardId ? reward : r);
        localStorage.setItem('physicalRewards', JSON.stringify(updatedRewards));
        
        // Registrar canje
        const redemptions = JSON.parse(localStorage.getItem('redemptions') || '[]');
        redemptions.push({
          rewardId: reward.id,
          rewardName: reward.name,
          cost: reward.cost,
          date: new Date().toLocaleString('es-ES'),
          status: 'pendiente_entrega',
          studentName: JSON.parse(localStorage.getItem('currentUser') || '{}').name || 'Estudiante'
        });
        localStorage.setItem('redemptions', JSON.stringify(redemptions));
        
        alert(`¬°Premio canjeado exitosamente!\n${reward.name} por ${reward.cost} millas\n\nEl premio ser√° entregado en la pr√≥xima clase.`);
        loadDashboardData();
        loadRewards();
      }
      
      function continueCourse(courseId) {
        alert(`Continuando curso ${courseId}...`);
      }
      
      function logout() {
        localStorage.removeItem('currentUser');
        window.location.href = 'login.html';
      }
    </script>
  </body>
</html>
